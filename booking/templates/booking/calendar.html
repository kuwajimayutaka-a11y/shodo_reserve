{% extends "base.html" %}

{% block title %}予約カレンダー{% endblock %}

{% block content %}
<h2>予約カレンダー</h2>

<div style="margin-bottom: 20px;">
    {% if user.is_staff %}
        | <a href="{% url 'admin_dashboard' %}">管理者ダッシュボード</a>
    {% endif %}
</div>

{% if messages %}
    {% for message in messages %}
        <div style="padding: 10px; margin: 10px 0; background-color: {% if message.tags == 'success' %}#d4edda{% elif message.tags == 'error' %}#f8d7da{% else %}#d1ecf1{% endif %}; border: 1px solid {% if message.tags == 'success' %}#c3e6cb{% elif message.tags == 'error' %}#f5c6cb{% else %}#bee5eb{% endif %}; border-radius: 4px;">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

{% if not students %}
    <p style="color: red;">予約を行うには生徒の登録が必要です。</p>
    <a href="{% url 'view_students' %}">生徒情報</a>
{% endif %}

<h3>予約済みの授業</h3>
{% if user.is_authenticated %}
    {% for student in students %}
        {% if student.reservation_set.all %}
            <div style="margin-bottom: 10px; padding: 15px; border: 1px solid #ccc; border-radius: 6px; background: #f9fbff;">
                
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4 style="margin:0;">{{ student.name }} の予約一覧</h4>
                    <button type="button"
                        class="toggle-btn"
                        data-target="student-{{ student.id }}-reservations"
                        style="padding:4px 10px; font-size:0.9em;">
                        ▼ 開く
                    </button>
                </div>

                <!-- 折りたたみ対象 -->
                <div id="student-{{ student.id }}-reservations" class="reservation-content" style="display:none; margin-top:10px;">
                    {% for reservation in student.reservation_set.all %}
                        <div style="margin: 12px 0; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: #e7f3ff;">
                            <strong>{{ reservation.lesson_slot.title|default:"書道教室" }}</strong><br>
                            <span style="color:#555;">{{ reservation.lesson_slot.start_time|date:"Y年m月d日 H:i" }} - {{ reservation.lesson_slot.end_time|date:"H:i" }}</span>
                            <div style="margin-top: 8px;">
                                <a href="{% url 'cancel_reservation' reservation.id %}"
                                   style="padding: 6px 12px; background: #dc3545; color: #fff; border-radius: 4px; text-decoration: none; font-size: 0.9em;">
                                   キャンセル
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endfor %}
{% else %}
     <p style="color: #6c757d;">予約済みの授業はありません。</p>
{% endif %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".toggle-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const targetId = this.getAttribute("data-target");
            const content = document.getElementById(targetId);

            if (content.style.display === "none") {
                content.style.display = "block";
                this.textContent = "▲ 閉じる";
            } else {
                content.style.display = "none";
                this.textContent = "▼ 開く";
            }
        });
    });
});
</script>


       
<h3 style="margin-top: 40px;">予約可能な授業</h3>

{% for date, lessons in lessons_by_date %}
    <div style="margin: 30px 0; padding: 20px; border: 2px solid #dee2e6; border-radius: 8px; background-color: #f8f9fa;">
        <h3 style="margin-top: 0; padding-bottom: 10px; border-bottom: 2px solid #007bff;">{{ date|date:"Y年m月d日 (D)" }}</h3>
        
        {% for lesson in lessons %}
            <div style="margin: 15px 0; padding: 15px; border: 1px solid #ced4da; border-radius: 4px; background-color: white;">
                <h4 style="margin-top: 0;">
                    {% if lesson.title %}
                        {{ lesson.title }}
                    {% else %}
                        書道教室
                    {% endif %}
                </h4>
                <p><strong>時間: {{ lesson.start_time|date:"H:i" }} - {{ lesson.end_time|date:"H:i" }}</strong></p>
                <p><strong>定員:</strong> {{ lesson.capacity }} / <strong>残り枠:</strong> 
                    <span style="color: {% if lesson.available_slots > 0 %}green{% else %}red{% endif %}; font-weight: bold;">
                        {{ lesson.available_slots }}
                    </span>
                </p>
                <p><strong>予約開始:</strong> {{ lesson.reservation_start_time|date:"Y年m月d日 H:i" }}</p>

                {% if user.is_authenticated and students %}
                    {% if lesson.is_reservable %}
                        <form method="post" action="{% url 'reserve_lesson' lesson.id %}" style="margin-top: 10px;">
                            {% csrf_token %}
                            <label for="student_{{ lesson.id }}">予約する生徒:</label>
                            <select name="student_id" id="student_{{ lesson.id }}" required style="margin: 0 10px; padding: 5px;">
                                {% for student in students %}
                                    <option value="{{ student.id }}">{{ student.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" style="padding: 8px 16px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">予約する</button>
                        </form>
                    {% elif lesson.available_slots <= 0 %}
                        <p style="color: orange; font-weight: bold;">満席です</p>
                        <form method="post" action="{% url 'reserve_lesson' lesson.id %}" style="margin-top: 10px;">
                    {% else %}
                        <p style="color: gray;">予約開始前です</p>
                    {% endif %}
                {% endif %}
            </div>
        {% endfor %}
    </div>
{% empty %}
    <p>現在、予約可能な授業枠はありません。</p>
{% endfor %}
{% endblock %}
