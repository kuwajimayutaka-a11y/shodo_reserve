{% extends "base.html" %}
{% block title %}管理者用予約カレンダー{% endblock %}

{% block content %}
<!-- Select2用CDN -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    h2, h3, h4 { color: #2c3e50; }
    a { color: #007bff; text-decoration: none; }
    a:hover { text-decoration: underline; }

    .reservation-card {
        margin: 15px 0;
        padding: 15px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background-color: white;
        max-width: 100%;
        overflow: hidden;
    }

    .reservation-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .reservation-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        flex-wrap: nowrap;
    }

    .reservation-item a.cancel-btn {
        background-color: #dc3545;
        color: white;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.85em;
        white-space: nowrap;
        text-decoration: none;
        display: inline-block;
        min-width: 70px;
        text-align: center;
    }

    form.reserve-form {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
    }

    form.reserve-form select {
        min-width: 200px;
        max-width: 100%;
    }

    form.reserve-form button {
        padding: 8px 16px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        white-space: nowrap;
    }

    @media (max-width: 768px) {
        form.reserve-form { flex-direction: column; align-items: stretch; }
        form.reserve-form select, form.reserve-form button { width: 100%; }
    }
</style>

<h2>管理者用予約カレンダー</h2>
<div style="margin-bottom: 20px;">
    <a href="{% url 'admin_dashboard' %}">← 管理者ダッシュボードへ戻る</a>
    | <a href="{% url 'admin_student_management' %}">生徒管理</a>
    | <a href="{% url 'admin_reservation_list' %}">予約一覧</a>
</div>

{% if messages %}
    {% for message in messages %}
        <div style="padding: 10px; margin: 10px 0; background-color: {% if message.tags == 'success' %}#d4edda{% elif message.tags == 'error' %}#f8d7da{% else %}#d1ecf1{% endif %}; border: 1px solid {% if message.tags == 'success' %}#c3e6cb{% elif message.tags == 'error' %}#f5c6cb{% else %}#bee5eb{% endif %}; border-radius: 4px;">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<h3 style="margin-top: 40px;">授業枠一覧と予約作成</h3>

{% for date, lessons in lessons_by_date %}
    <div style="margin: 30px 0; padding: 20px; border: 2px solid #dee2e6; border-radius: 8px; background-color: #f8f9fa;">
        <h3 style="margin-top: 0; padding-bottom: 10px; border-bottom: 2px solid #007bff;">{{ date|date:"Y年m月d日 (D)" }}</h3>
        
        {% for lesson in lessons %}
            <div class="reservation-card">
                <h4>{{ lesson.title|default:"書道教室" }}</h4>
                <p><strong>時間:</strong> {{ lesson.start_time|date:"H:i" }} - {{ lesson.end_time|date:"H:i" }}</p>
                <p><strong>定員:</strong> {{ lesson.capacity }} / <strong>残り枠:</strong> 
                    <span style="color: {% if lesson.available_slots > 0 %}green{% else %}red{% endif %}; font-weight: bold;">{{ lesson.available_slots }}</span>
                </p>
                <p><strong>予約開始:</strong> {{ lesson.reservation_start_time|date:"Y年m月d日 H:i" }}</p>

                {% if all_students %}
                    <form method="post" action="{% url 'admin_reserve_lesson' lesson.id %}" class="reserve-form">
                        {% csrf_token %}
                        <label for="student_{{ lesson.id }}">予約する生徒:</label>
                        <select name="student_id" id="student_{{ lesson.id }}" required class="select2">
                            <option value="">-- 生徒を選択 --</option>
                            {% for student in all_students %}
                                <option value="{{ student.id }}">{{ student.name }} ({{ student.family.user.username }})</option>
                            {% endfor %}
                        </select>
                        <button type="submit">予約する</button>
                    </form>
                {% else %}
                    <p style="color: #6c757d;">生徒が登録されていません。</p>
                {% endif %}

                {% if lesson.reservation_set.all %}
                    <div style="margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                        <strong>現在の予約:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            {% for reservation in lesson.reservation_set.all %}
                                <li>{{ reservation.student.name }} ({{ reservation.student.family.user.username }})</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>
{% empty %}
    <p>現在、授業枠はありません。</p>
{% endfor %}

<script>
    // Select2初期化
    document.addEventListener("DOMContentLoaded", function() {
        const selects = document.querySelectorAll('.select2');
        selects.forEach(select => {
            $(select).select2({ width: '100%' });
        });
    });
</script>

{% endblock %}
