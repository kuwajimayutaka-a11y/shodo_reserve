{% extends "base.html" %}

{% block title %}管理者用予約カレンダー{% endblock %}

{% block content %}
<h2>管理者用予約カレンダー</h2>

<div style="margin-bottom: 20px;">
    <a href="{% url 'admin_dashboard' %}">← 管理者ダッシュボードへ戻る</a>
    | <a href="{% url 'admin_student_management' %}">生徒管理</a>
    | <a href="{% url 'admin_reservation_list' %}">予約一覧</a>
</div>

{% if messages %}
    {% for message in messages %}
        <div style="padding: 10px; margin: 10px 0; background-color: {% if message.tags == 'success' %}#d4edda{% elif message.tags == 'error' %}#f8d7da{% else %}#d1ecf1{% endif %}; border: 1px solid {% if message.tags == 'success' %}#c3e6cb{% elif message.tags == 'error' %}#f5c6cb{% else %}#bee5eb{% endif %}; border-radius: 4px;">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<h3>全体の予約状況</h3>
<div style="margin: 20px 0;">
    {% for date, lessons in lessons_by_date %}
        <div style="margin-bottom: 20px;">
            {% for lesson in lessons %}
                {% if lesson.reservation_set.all %}
                    <div style="margin-bottom: 15px; padding: 15px; border: 1px solid #dee2e6; border-radius: 4px; background-color: #e7f3ff;">
                        <h4 style="margin-top: 0;">
                            {% if lesson.title %}{{ lesson.title }}{% else %}書道教室{% endif %}
                            - {{ lesson.start_time|date:"Y年m月d日 H:i" }}
                        </h4>
                        <div style="display: grid; gap: 10px;">
                            {% for reservation in lesson.reservation_set.all %}
                                <div style="padding: 10px; border: 1px solid #ced4da; border-radius: 4px; background-color: white; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>{{ reservation.student.name }}</strong>
                                        <span style="color: #6c757d; font-size: 0.9em;">({{ reservation.student.family.user.username }})</span>
                                    </div>
                                    <a href="{% url 'admin_cancel_reservation' reservation.id %}" style="padding: 6px 12px; background-color: #dc3545; color: white; text-decoration: none; border-radius: 4px; font-size: 0.85em;">キャンセル</a>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    {% empty %}
        <p style="color: #6c757d;">予約済みの授業はありません。</p>
    {% endfor %}
</div>

<h3 style="margin-top: 40px;">授業枠一覧と予約作成</h3>

{% for date, lessons in lessons_by_date %}
    <div style="margin: 30px 0; padding: 20px; border: 2px solid #dee2e6; border-radius: 8px; background-color: #f8f9fa;">
        <h3 style="margin-top: 0; padding-bottom: 10px; border-bottom: 2px solid #007bff;">{{ date|date:"Y年m月d日 (D)" }}</h3>
        
        {% for lesson in lessons %}
            <div style="margin: 15px 0; padding: 15px; border: 1px solid #ced4da; border-radius: 4px; background-color: white;">
                <h4 style="margin-top: 0;">
                    {% if lesson.title %}
                        {{ lesson.title }}
                    {% else %}
                        書道教室
                    {% endif %}
                </h4>
                <p><strong>時間:</strong> {{ lesson.start_time|date:"H:i" }} - {{ lesson.end_time|date:"H:i" }}</p>
                <p><strong>定員:</strong> {{ lesson.capacity }} / <strong>残り枠:</strong> 
                    <span style="color: {% if lesson.available_slots > 0 %}green{% else %}red{% endif %}; font-weight: bold;">
                        {{ lesson.available_slots }}
                    </span>
                </p>
                <p><strong>予約開始:</strong> {{ lesson.reservation_start_time|date:"Y年m月d日 H:i" }}</p>

                <!-- 管理者は全生徒を予約可能 -->
                {% if all_students %}
                    <form method="post" action="{% url 'admin_reserve_lesson' lesson.id %}" style="margin-top: 10px;">
                        {% csrf_token %}
                        <label for="student_{{ lesson.id }}">予約する生徒:</label>
                        <select name="student_id" id="student_{{ lesson.id }}" required style="margin: 0 10px; padding: 5px; width: 250px;">
                            <option value="">-- 生徒を選択 --</option>
                            {% for student in all_students %}
                                <option value="{{ student.id }}">{{ student.name }} ({{ student.family.user.username }})</option>
                            {% endfor %}
                        </select>
                        <button type="submit" style="padding: 8px 16px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">予約する</button>
                    </form>
                {% else %}
                    <p style="color: #6c757d;">生徒が登録されていません。</p>
                {% endif %}

                <!-- 現在の予約一覧 -->
                {% if lesson.reservation_set.all %}
                    <div style="margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                        <strong>現在の予約:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            {% for reservation in lesson.reservation_set.all %}
                                <li>{{ reservation.student.name }} ({{ reservation.student.family.user.username }})</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>
{% empty %}
    <p>現在、授業枠はありません。</p>
{% endfor %}
{% endblock %}
